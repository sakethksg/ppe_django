{% extends 'myapp/base.html' %}

{% block title %}Upload Image - PPE Detection{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-white dark:bg-dark-100 shadow-sm rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Upload Image for PPE Detection</h2>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                    Upload an image to detect personal protective equipment
                </p>
            </div>
            
            {% if error %}
            <div class="rounded-md bg-red-50 dark:bg-red-900/20 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800 dark:text-red-400">{{ error }}</h3>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if success %}
            <div class="rounded-md bg-green-50 dark:bg-green-900/20 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800 dark:text-green-400">{{ success }}</h3>
                    </div>
                </div>
            </div>
            {% endif %}

            <form id="upload-form" method="post" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                <div id="drop-area" class="flex flex-col items-center justify-center border-2 border-dashed border-primary-300 dark:border-primary-700 rounded-lg p-8 mb-4 bg-primary-50 dark:bg-dark-200 cursor-pointer transition hover:bg-primary-100 dark:hover:bg-dark-300">
                    <svg class="h-12 w-12 text-primary-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16v-4a4 4 0 018 0v4m-4 4v-4m0 0V4m0 8H4m8 0h8" />
                    </svg>
                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">Drag & drop an image here, or click to select</p>
                    <input id="file-input" name="file" type="file" accept="image/*" class="hidden" required>
                    <button type="button" id="select-file-btn" class="mt-2 px-4 py-2 bg-primary text-white rounded-md shadow hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">Select Image</button>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gradient-to-r from-primary-600 to-blue-500 hover:from-primary-700 hover:to-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">Upload</button>
            </form>

            {% if input_file and output_file %}
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-gray-50 dark:bg-dark-200 rounded-lg p-4 flex flex-col items-center">
                    <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Original Image</h3>
                    <img src="{{ input_file }}" alt="Original Image" class="rounded-lg shadow-md max-h-80">
                </div>
                <div class="bg-gray-50 dark:bg-dark-200 rounded-lg p-4 flex flex-col items-center">
                    <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Processed Image</h3>
                    <img src="{{ output_file }}" alt="Processed Image" class="rounded-lg shadow-md max-h-80">
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const selectFileBtn = document.getElementById('select-file-btn');
    const uploadForm = document.getElementById('upload-form');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // Highlight drop area on dragover
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.add('ring', 'ring-primary-400');
        }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.remove('ring', 'ring-primary-400');
        }, false);
    });

    // Handle drop
    dropArea.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
        }
    });

    // Open file dialog on button click or drop area click
    selectFileBtn.addEventListener('click', () => fileInput.click());
    dropArea.addEventListener('click', () => fileInput.click());

    // Submit form when file is selected
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            uploadForm.submit();
        }
    });
</script>
{% endblock %}
